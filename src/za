// ==UserScript==
// @name         Zampto Auto Renew (v3.9 Smart Wait)
// @namespace    http://tampermonkey.net/
// @version      3.9
// @description  æ™ºèƒ½è°ƒè¯•ç‰ˆï¼šå¿…é¡»ç­‰åˆ°â€œç»­æœŸå¡ç‰‡â€åŠ è½½å‡ºæ¥æ‰æ“ä½œï¼Œé˜²æ­¢ç™½å±æ­»å¾ªç¯
// @author       Gemini
// @match        https://dash.zampto.net/server?id=2574*
// @grant        none
// ==/UserScript==

(function() {
    'use strict';

    // --- 1. é…ç½® ---
    const CONFIG = {
        storageKey: 'zampto_v3_9_smart',
        btnText: "Renew Server",
        debugInterval: 2 * 60 * 1000, // è°ƒè¯•å¾ªç¯ï¼š2åˆ†é’Ÿ
        waitTimeout: 60 * 1000        // å®‰å…¨é”ï¼šå¦‚æœ60ç§’å¡ç‰‡è¿˜æ²¡å‡ºæ¥ï¼Œåœæ­¢è„šæœ¬
    };

    // --- 2. çŠ¶æ€ ---
    let data = JSON.parse(localStorage.getItem(CONFIG.storageKey)) || {
        nextRunTime: 0,
        status: 'idle',
        logs: [],
        lastExpiryMinutes: 0
    };

    // --- 3. æ ¸å¿ƒå·¥å…· ---
    function simulateClick(element) {
        if (!element) return;
        ['mouseover', 'mousedown', 'mouseup', 'click'].forEach(eventType => {
            const event = new MouseEvent(eventType, { bubbles: true, cancelable: true, view: window });
            element.dispatchEvent(event);
        });
    }

    // æ™ºèƒ½å…ƒç´ æŸ¥æ‰¾ï¼ˆå¸¦è¶…æ—¶ï¼‰
    function waitForCard(callback) {
        const start = Date.now();
        const check = setInterval(() => {
            // æŸ¥æ‰¾åŒ…å« Renew Server çš„æŒ‰é’®æˆ–é“¾æ¥
            const btn = Array.from(document.querySelectorAll('button, a')).find(el => el.textContent.includes(CONFIG.btnText));
            
            // æ‰¾åˆ°äº†ï¼
            if (btn) {
                clearInterval(check);
                callback(btn);
                return;
            }

            // è¶…æ—¶ä¿æŠ¤
            if (Date.now() - start > CONFIG.waitTimeout) {
                clearInterval(check);
                log("âŒ ä¸¥é‡é”™è¯¯ï¼šå¡ç‰‡åŠ è½½è¶…æ—¶ (60s)ï¼Œè„šæœ¬å·²è‡ªåŠ¨åœæ­¢", "#f44336");
                updateStatus("ğŸ”´ é¡µé¢å¡æ­»ï¼Œè¯·æ‰‹åŠ¨åˆ·æ–°", "#f44336");
            }
        }, 1000); // æ¯ç§’æ£€æŸ¥ä¸€æ¬¡
    }

    function getCleanExpiryMinutes() {
        const elements = Array.from(document.querySelectorAll('p, div, span, li'));
        const target = elements.find(el => el.textContent.includes('Expiry') && !el.textContent.includes('function') && el.innerText.length < 150);
        if (!target) return 0;
        const text = target.innerText;
        let total = 0;
        text.replace(/(\d+)\s*day/g, (_, d) => total += d * 1440);
        text.replace(/(\d+)\s*h/g, (_, h) => total += h * 60);
        text.replace(/(\d+)\s*m/g, (_, m) => total += parseInt(m));
        return total;
    }

    function getExpiryDisplay() {
        const elements = Array.from(document.querySelectorAll('p, div, span, li'));
        const target = elements.find(el => el.textContent.includes('Expiry') && !el.textContent.includes('function'));
        return target ? target.innerText.replace('Expiry (Next Renewal):', '').trim() : "è·å–ä¸­...";
    }

    // --- 4. UI ---
    const panel = document.createElement('div');
    panel.style = "position:fixed;bottom:10px;right:10px;width:420px;background:#202124;color:#ccc;z-index:999999;border:1px solid #5f6368;padding:12px;font-family:'Consolas', monospace;font-size:12px;box-shadow: 0 0 20px rgba(0,0,0,0.8);border-radius:8px;";
    
    panel.innerHTML = `
        <div style="border-bottom:1px solid #5f6368;margin-bottom:8px;padding-bottom:5px;display:flex;justify-content:space-between;align-items:center;">
            <span style="font-weight:bold;color:#8ab4f8;font-size:14px;">ğŸ›¡ï¸ Zampto v3.9 (æ™ºèƒ½é˜²å¡)</span>
            <button id="kb-hide" style="background:none;border:none;color:#9aa0a6;cursor:pointer;">[-]</button>
        </div>
        <div id="kb-content">
            <div id="kb-status" style="margin-bottom:10px;color:#fff;font-size:13px;background:#303134;padding:8px;border-radius:4px;border-left:4px solid #8ab4f8;">åˆå§‹åŒ–...</div>
            <div style="margin-bottom:10px;display:flex;gap:10px;">
                <button id="kb-reset" style="background:#d93025;color:white;border:none;padding:6px 15px;cursor:pointer;border-radius:4px;font-weight:bold;">æ€¥åœ / é‡ç½®</button>
            </div>
            <div id="kb-logs" style="height:350px;overflow-y:auto;border:1px solid #3c4043;padding:8px;background:#000;border-radius:4px;line-height:1.4;"></div>
        </div>
    `;
    document.body.appendChild(panel);

    function log(msg, color = "#bdc1c6") {
        const time = new Date().toLocaleTimeString();
        data.logs.unshift(`<div style="color:${color};margin-bottom:4px;border-bottom:1px dashed #3c4043;padding-bottom:2px;"><span style="color:#5f6368">[${time}]</span> ${msg}</div>`);
        if (data.logs.length > 60) data.logs.pop();
        localStorage.setItem(CONFIG.storageKey, JSON.stringify(data));
        renderLogs();
    }
    
    function renderLogs() { const el = document.getElementById('kb-logs'); if(el) el.innerHTML = data.logs.join(''); }
    function updateStatus(text, borderColor = "#8ab4f8") { 
        const el = document.getElementById('kb-status');
        if(el) { el.innerHTML = text; el.style.borderLeftColor = borderColor; }
    }

    // --- 5. é€»è¾‘æµç¨‹ ---

    // é˜¶æ®µA: å€’è®¡æ—¶ç»“æŸ -> åˆ·æ–°
    function startRefresh() {
        log("â° è°ƒè¯•å‘¨æœŸç»“æŸï¼Œå‡†å¤‡åˆ·æ–°...", "#fbbc04");
        data.status = 'waiting_for_load'; // æ ‡è®°ï¼šæ­£åœ¨ç­‰ç½‘é¡µåŠ è½½
        localStorage.setItem(CONFIG.storageKey, JSON.stringify(data));
        
        setTimeout(() => location.reload(), 1000);
    }

    // é˜¶æ®µB: ç½‘é¡µåŠ è½½ä¸­ -> ç­‰å¾…å¡ç‰‡å‡ºç°
    function waitForPageLoad() {
        updateStatus("ğŸ”¥ æ­£åœ¨ç­‰å¾…ç½‘é¡µå†…å®¹æ¸²æŸ“...", "#fbbc04");
        
        waitForCard((btn) => {
            log("âœ… å¡ç‰‡/æŒ‰é’®å·²åŠ è½½ï¼", "#81c995");
            executeClick(btn);
        });
    }

    // é˜¶æ®µC: æ‰§è¡Œç‚¹å‡»
    async function executeClick(btn) {
        data.lastExpiryMinutes = getCleanExpiryMinutes();
        
        updateStatus("ğŸš€ æ­£åœ¨ç‚¹å‡»ç»­æœŸ...", "#8ab4f8");
        simulateClick(btn);
        log("ğŸš€ åŠ¨ä½œå·²å‘é€ï¼Œç­‰å¾…å“åº”...", "#d2e3fc");
        
        // ç‚¹å‡»åç­‰å¾… 10 ç§’
        await new Promise(r => setTimeout(r, 10000));
        
        checkResult();
    }

    // é˜¶æ®µD: éªŒè¯
    function checkResult() {
        const currentMinutes = getCleanExpiryMinutes();
        const displayTime = getExpiryDisplay();
        
        if (currentMinutes > data.lastExpiryMinutes || currentMinutes > 2000) {
            log(`âœ… [è°ƒè¯•æˆåŠŸ] æ—¶é—´å·²æ›´æ–°: ${displayTime}`, "#81c995");
        } else {
            log(`âš ï¸ [è°ƒè¯•] æ—¶é—´æœªå˜ (å½“å‰: ${displayTime})`, "#ea4335");
        }
        
        // é‡æ–°è¿›å…¥å¾ªç¯
        log("â³ è¿›å…¥ä¸‹ä¸€è½® 2åˆ†é’Ÿ å€’è®¡æ—¶", "#fff");
        data.status = 'idle';
        data.nextRunTime = Date.now() + CONFIG.debugInterval;
        localStorage.setItem(CONFIG.storageKey, JSON.stringify(data));
    }

    // --- 6. ä¸»å¾ªç¯ ---
    setInterval(() => {
        const now = Date.now();

        // åˆšåˆšåˆ·æ–°å›æ¥
        if (data.status === 'waiting_for_load') {
            // åªæœ‰è¿™é‡Œä¸å†å‚»ç­‰ç§’æ•°ï¼Œè€Œæ˜¯å»æ£€æµ‹ DOM
            // é¿å…é‡å¤è°ƒç”¨ï¼ŒåŠ ä¸ªé”ï¼Ÿå…¶å® waitForCard å†…éƒ¨æœ‰ intervalï¼Œè¿™é‡Œåªè¦ä¸é‡å¤è¿›å°±è¡Œ
            // ç®€å•å¤„ç†ï¼šçŠ¶æ€å³ä¸ºé”
            data.status = 'loading_check_active'; 
            waitForPageLoad();
            return;
        }
        
        // æ­£åœ¨æ£€æµ‹ä¸­ï¼Œä¸»å¾ªç¯ç©ºè½¬å³å¯
        if (data.status === 'loading_check_active') return;

        // å€’è®¡æ—¶æ¨¡å¼
        if (data.status === 'idle') {
            if (now < data.nextRunTime) {
                const diff = data.nextRunTime - now;
                const m = Math.floor((diff % 3600000) / 60000);
                const s = Math.floor((diff % 60000) / 1000);
                updateStatus(`â³ è°ƒè¯•å€’è®¡æ—¶: ${m}åˆ†${s}ç§’ ååˆ·æ–°`);
            } else {
                startRefresh();
            }
        }
    }, 1000);

    // --- 7. äº¤äº’ ---
    renderLogs();
    
    document.getElementById('kb-reset').onclick = () => {
        data = { nextRunTime: 0, status: 'idle', logs: [], lastExpiryMinutes: 0 };
        localStorage.setItem(CONFIG.storageKey, JSON.stringify(data));
        // é‡ç½®æ—¶åªåˆ·æ–°ï¼Œä¸ç«‹å³æ‰§è¡Œï¼Œç»™ç”¨æˆ·å–˜æ¯æ—¶é—´
        location.reload(); 
    };
    
    document.getElementById('kb-hide').onclick = () => {
        const content = document.getElementById('kb-content');
        content.style.display = content.style.display === 'none' ? 'block' : 'none';
    };

    log("ğŸ›¡ï¸ v3.9 æ™ºèƒ½ç­‰å¾…æ¨¡å¼ (é˜²ç™½å±)", "#fff");

    // å¯åŠ¨æ—¶çš„å®‰å…¨æ£€æŸ¥ï¼šå¦‚æœå¡åœ¨ waiting_for_load çŠ¶æ€å¤ªä¹…ï¼ˆæ¯”å¦‚è„šæœ¬æ„å¤–ç»ˆæ­¢ï¼‰ï¼Œè‡ªåŠ¨æ¢å¤æ£€æµ‹
    if (data.status === 'waiting_for_load') {
        waitForPageLoad();
    }

})();
