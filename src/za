// ==UserScript==
// @name         Zampto Auto Renew (v4.0 Stable Debug)
// @namespace    http://tampermonkey.net/
// @version      4.0
// @description  å®Œæ•´åŠŸèƒ½ç‰ˆï¼š2åˆ†é’Ÿå¾ªç¯ + åˆ·æ–°é¢„çƒ­ + è‡ªåŠ¨è¯†åˆ«ç½‘é¡µåˆ·æ–°ç»“æœ + ç²¾å‡†æ—¶é—´æ¯”å¯¹
// @author       Gemini
// @match        https://dash.zampto.net/server?id=2574*
// @grant        none
// ==/UserScript==

(function() {
    'use strict';

    // --- 1. å…¨å±€é…ç½® ---
    const CONFIG = {
        storageKey: 'zampto_v4_0_full',
        btnText: "Renew Server",
        renewInterval: 2 * 60 * 1000,    // ã€è°ƒè¯•ã€‘2åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
        warmupDuration: 15 * 1000,       // ã€é¢„çƒ­ã€‘åˆ·æ–°åç­‰å¾… 15ç§’ å†ç‚¹å‡»
        fallbackReload: 30 * 1000        // ã€ä¿é™©ã€‘å¦‚æœç‚¹å‡»å30ç§’ç½‘é¡µæ²¡è‡ªåŠ¨åˆ·æ–°ï¼Œè„šæœ¬å¼ºåˆ¶åˆ·æ–°æŸ¥ç»“æœ
    };

    // --- 2. çŠ¶æ€ç®¡ç† ---
    // status çŠ¶æ€æµè½¬: 
    // idle (å€’è®¡æ—¶) -> pre_refresh (å‡†å¤‡åˆ·æ–°) -> warmup (åˆ·æ–°å½’æ¥ç­‰å¾…ç‚¹å‡») -> validating (ç‚¹å‡»åç­‰å¾…è‡ªåŠ¨åˆ·æ–°éªŒè¯)
    let data = JSON.parse(localStorage.getItem(CONFIG.storageKey)) || {
        nextRunTime: 0,
        status: 'idle', 
        logs: [],
        lastExpiryMinutes: 0,
        warmupEndTime: 0,
        validateStartTime: 0
    };

    // --- 3. æ ¸å¿ƒå·¥å…·å‡½æ•° (ä¿ç•™æ‰€æœ‰åŠŸèƒ½) ---

    // æ¨¡æ‹Ÿç‚¹å‡»
    function simulateClick(element) {
        if (!element) return;
        ['mouseover', 'mousedown', 'mouseup', 'click'].forEach(eventType => {
            const event = new MouseEvent(eventType, { bubbles: true, cancelable: true, view: window });
            element.dispatchEvent(event);
        });
    }

    // ç²¾å‡†è¯»å–å‰©ä½™æ—¶é—´ (åˆ†é’Ÿæ•°)
    function getCleanExpiryMinutes() {
        const elements = Array.from(document.querySelectorAll('p, div, span, li'));
        const target = elements.find(el => el.textContent.includes('Expiry') && !el.textContent.includes('function') && el.innerText.length < 150);
        if (!target) return 0;
        
        const text = target.innerText;
        let total = 0;
        text.replace(/(\d+)\s*day/g, (_, d) => total += d * 1440);
        text.replace(/(\d+)\s*h/g, (_, h) => total += h * 60);
        text.replace(/(\d+)\s*m/g, (_, m) => total += parseInt(m));
        return total;
    }

    // è·å–æ˜¾ç¤ºçš„æ–‡æœ¬æ—¶é—´
    function getExpiryDisplay() {
        const elements = Array.from(document.querySelectorAll('p, div, span, li'));
        const target = elements.find(el => el.textContent.includes('Expiry') && !el.textContent.includes('function'));
        return target ? target.innerText.replace('Expiry (Next Renewal):', '').trim() : "è·å–ä¸­...";
    }

    // --- 4. UI é¢æ¿ (å®Œæ•´ç‰ˆ) ---
    const panel = document.createElement('div');
    panel.style = "position:fixed;bottom:10px;right:10px;width:450px;background:#121212;color:#e0e0e0;z-index:999999;border:1px solid #333;padding:12px;font-family:'Consolas', monospace;font-size:12px;box-shadow: 0 0 25px rgba(0,0,0,0.8);border-radius:8px;";
    
    panel.innerHTML = `
        <div style="border-bottom:1px solid #333;margin-bottom:10px;padding-bottom:5px;display:flex;justify-content:space-between;align-items:center;">
            <span style="font-weight:bold;color:#4caf50;font-size:14px;">ğŸ› ï¸ Zampto v4.0 (Full Logic)</span>
            <button id="kb-hide" style="background:none;border:none;color:#666;cursor:pointer;">[-]</button>
        </div>
        <div id="kb-content">
            <div id="kb-status" style="margin-bottom:10px;color:#fff;font-size:13px;background:#262626;padding:10px;border-radius:4px;border-left:5px solid #4caf50;">åˆå§‹åŒ–...</div>
            <div style="margin-bottom:10px;display:flex;gap:10px;">
                <button id="kb-reset" style="background:#d32f2f;color:white;border:none;padding:6px 15px;cursor:pointer;border-radius:4px;font-weight:bold;">âš ï¸ é‡ç½®ä¸€åˆ‡</button>
                <button id="kb-check" style="background:#1976d2;color:white;border:none;padding:6px 15px;cursor:pointer;border-radius:4px;font-weight:bold;">ğŸ” è¯»å–æ—¶é—´æµ‹è¯•</button>
            </div>
            <div id="kb-logs" style="height:350px;overflow-y:auto;border:1px solid #333;padding:8px;background:#000;border-radius:4px;line-height:1.5;"></div>
        </div>
    `;
    document.body.appendChild(panel);

    // æ—¥å¿—ç³»ç»Ÿ
    function log(msg, color = "#aaa") {
        const time = new Date().toLocaleTimeString();
        data.logs.unshift(`<div style="color:${color};margin-bottom:4px;border-bottom:1px dashed #222;padding-bottom:2px;"><span style="color:#555">[${time}]</span> ${msg}</div>`);
        if (data.logs.length > 80) data.logs.pop();
        localStorage.setItem(CONFIG.storageKey, JSON.stringify(data));
        renderLogs();
    }
    
    function renderLogs() { const el = document.getElementById('kb-logs'); if(el) el.innerHTML = data.logs.join(''); }
    function updateStatus(text, borderColor = "#4caf50") { 
        const el = document.getElementById('kb-status');
        if(el) { el.innerHTML = text; el.style.borderLeftColor = borderColor; }
    }

    // --- 5. æ ¸å¿ƒé€»è¾‘å¼•æ“ ---

    // [é€»è¾‘1] å€’è®¡æ—¶ç»“æŸï¼Œæ‰§è¡Œé¢„åˆ·æ–°
    function startCycle() {
        log("â° å‘¨æœŸç»“æŸï¼Œå‡†å¤‡åˆ·æ–°é¡µé¢ä»¥è·å–æ–°Token...", "#ff9800");
        data.status = 'warmup';
        // è®¾å®šé¢„çƒ­ç»“æŸæ—¶é—´ (ç°åœ¨ + 15ç§’)
        data.warmupEndTime = Date.now() + CONFIG.warmupDuration;
        localStorage.setItem(CONFIG.storageKey, JSON.stringify(data));
        location.reload();
    }

    // [é€»è¾‘2] åˆ·æ–°å½’æ¥ï¼Œæ‰§è¡Œé¢„çƒ­ç­‰å¾…
    function processWarmup() {
        const now = Date.now();
        const diff = data.warmupEndTime - now;

        if (diff > 0) {
            const s = Math.ceil(diff / 1000);
            updateStatus(`ğŸ”¥ ç½‘é¡µé¢„çƒ­ä¸­... è¯·å‹¿æ“ä½œ (${s}ç§’)`, "#ffc107");
            return;
        }

        // é¢„çƒ­ç»“æŸï¼Œæ‰§è¡Œç‚¹å‡»
        log("âœ… é¢„çƒ­å®Œæ¯•ï¼Œå¼€å§‹è¯»å–æ—¶é—´å¹¶ç‚¹å‡»", "#4caf50");
        executeClick();
    }

    // [é€»è¾‘3] ç‚¹å‡»æŒ‰é’®
    function executeClick() {
        // 1. è¯»å–å½“å‰æ—¶é—´ (ä½œä¸ºåŸºå‡†)
        const currentDisplay = getExpiryDisplay();
        const minutes = getCleanExpiryMinutes();
        
        if (minutes === 0) {
            log("âš ï¸ æœªèƒ½è¯»å–åˆ°æ—¶é—´ï¼Œå¯èƒ½é¡µé¢æœªåŠ è½½å®Œå…¨ï¼Œé‡è¯•...", "#f44336");
            return; // ä¸‹ä¸€ç§’ä¸»å¾ªç¯ä¼šå†æ¬¡å°è¯•è°ƒç”¨ processWarmup -> executeClick
        }

        data.lastExpiryMinutes = minutes;
        
        // 2. å¯»æ‰¾æŒ‰é’®
        const btn = Array.from(document.querySelectorAll('button, a')).find(el => el.textContent.includes(CONFIG.btnText));
        
        if (btn) {
            log(`ğŸ“Š ç‚¹å‡»å‰æ—¶é—´: ${currentDisplay}`, "#2196f3");
            log("ğŸ–±ï¸ æ­£åœ¨ç‚¹å‡»ç»­æœŸæŒ‰é’®...", "#ba68c8");
            
            // 3. æ”¹å˜çŠ¶æ€ä¸º validating (ç­‰å¾…è‡ªåŠ¨åˆ·æ–°)
            data.status = 'validating';
            data.validateStartTime = Date.now(); // è®°å½•å¼€å§‹éªŒè¯çš„æ—¶é—´
            localStorage.setItem(CONFIG.storageKey, JSON.stringify(data));

            updateStatus("ğŸš€ ç‚¹å‡»åŠ¨ä½œå·²å‘é€ï¼Œç­‰å¾…ç½‘é¡µè‡ªåŠ¨åˆ·æ–°...", "#ba68c8");
            simulateClick(btn);
            
            // æ³¨æ„ï¼šè¿™é‡Œæˆ‘ä»¬ä¸ä¸»åŠ¨åˆ·æ–°ï¼Œå› ä¸ºä½ è¯´ç½‘é¡µä¼šè‡ªåŠ¨åˆ·æ–°
            // ä½†ä¸ºäº†é˜²æ­¢ç½‘é¡µå¡æ­»ä¸åˆ·æ–°ï¼Œä¸»å¾ªç¯é‡ŒåŠ äº†ä¸€ä¸ªè¶…æ—¶æ£€æŸ¥
        } else {
            log("âŒ æœªæ‰¾åˆ°æŒ‰é’®ï¼Œ5ç§’åé‡è¯•", "#f44336");
            // å»¶é•¿é¢„çƒ­æ—¶é—´5ç§’ï¼Œè®©å®ƒç»§ç»­æ‰¾
            data.warmupEndTime = Date.now() + 5000;
            localStorage.setItem(CONFIG.storageKey, JSON.stringify(data));
        }
    }

    // [é€»è¾‘4] éªŒè¯ç»“æœ (åœ¨ç½‘é¡µè‡ªåŠ¨åˆ·æ–°å½’æ¥åæ‰§è¡Œ)
    function checkResult() {
        const currentMinutes = getCleanExpiryMinutes();
        const displayTime = getExpiryDisplay();

        // åˆšåŠ è½½å¯èƒ½è¯»ä¸åˆ°æ—¶é—´ï¼Œç»™å®ƒä¸€ç‚¹å®½å®¹åº¦
        if (currentMinutes === 0) {
            updateStatus("ğŸ” é¡µé¢åˆšåŠ è½½ï¼Œæ­£åœ¨å¯»æ‰¾æ—¶é—´å…ƒç´ ...", "#2196f3");
            return;
        }

        // æˆåŠŸåˆ¤æ–­ï¼šæ—¶é—´å¢åŠ äº†ï¼Œæˆ–è€…æ—¶é—´å¤§äº1.5å¤©(2000åˆ†é’Ÿ)
        if (currentMinutes > data.lastExpiryMinutes || currentMinutes > 2000) {
            log(`âœ… ç»­æœŸæˆåŠŸ! æ–°æ—¶é—´: ${displayTime}`, "#4caf50");
            updateStatus("âœ… ä»»åŠ¡å®Œæˆï¼Œç­‰å¾…ä¸‹ä¸ªå¾ªç¯", "#4caf50");
        } else {
            log(`âš ï¸ æ—¶é—´æœªå˜ (å½“å‰: ${displayTime})ï¼Œå¯èƒ½ç‚¹å‡»æœªç”Ÿæ•ˆ`, "#ff9800");
        }
        
        // æ— è®ºæˆåŠŸå¤±è´¥ï¼Œè¿›å…¥ä¸‹ä¸€è½®å€’è®¡æ—¶
        log("â³ 2åˆ†é’Ÿè°ƒè¯•å€’è®¡æ—¶å¼€å§‹...", "#fff");
        data.status = 'idle';
        data.nextRunTime = Date.now() + CONFIG.renewInterval;
        localStorage.setItem(CONFIG.storageKey, JSON.stringify(data));
    }

    // --- 6. ä¸»å¾ªç¯ (æ¯ç§’æ‰§è¡Œ) ---
    setInterval(() => {
        const now = Date.now();

        // çŠ¶æ€A: åˆšåˆ·æ–°å›æ¥ (Warmup)
        if (data.status === 'warmup') {
            processWarmup();
            return;
        }

        // çŠ¶æ€B: åˆšç‚¹å‡»å®Œ (Validating) - ç­‰å¾…ç½‘é¡µè‡ªåŠ¨åˆ·æ–°
        if (data.status === 'validating') {
            // è¿™é‡Œæœ‰ä¸¤ç§æƒ…å†µï¼š
            // 1. ç½‘é¡µè¿˜æ²¡åˆ·æ–° -> æˆ‘ä»¬æ˜¾ç¤ºç­‰å¾…çŠ¶æ€
            // 2. ç½‘é¡µå·²ç»åˆ·æ–°äº† -> è„šæœ¬é‡æ–°åŠ è½½æ—¶ï¼Œä¼šç«‹å³è¿›å…¥è¿™é‡Œ

            // æ£€æŸ¥æ˜¯å¦åˆšåˆšé‡æ–°åŠ è½½ (é€šè¿‡ performance API åˆ¤æ–­é¡µé¢è¿è¡Œæ—¶é—´å¾ˆçŸ­)
            if (performance.now() < 5000) {
                // é¡µé¢åˆšå¯åŠ¨ä¸”çŠ¶æ€æ˜¯ validatingï¼Œè¯´æ˜æ˜¯è‡ªåŠ¨åˆ·æ–°å›æ¥äº†ï¼
                checkResult();
            } else {
                // é¡µé¢è¿è¡Œå¾ˆä¹…äº†çŠ¶æ€è¿˜æ˜¯ validatingï¼Œè¯´æ˜ç‚¹å‡»åç½‘é¡µæ²¡è‡ªåŠ¨åˆ·æ–°
                const waitTime = now - data.validateStartTime;
                updateStatus(`ğŸš€ ç­‰å¾…ç½‘é¡µè‡ªåŠ¨åˆ·æ–°... (${Math.floor(waitTime/1000)}s)`, "#ba68c8");
                
                // ä¿é™©ä¸ï¼šå¦‚æœè¶…è¿‡ 30ç§’ è¿˜æ²¡åˆ·æ–°ï¼Œæ‰‹åŠ¨åˆ·æ–°ä¸€æ¬¡å»æŸ¥ç»“æœ
                if (waitTime > CONFIG.fallbackReload) {
                    log("âš ï¸ ç­‰å¾…è‡ªåŠ¨åˆ·æ–°è¶…æ—¶ï¼Œå¼ºåˆ¶æ‰‹åŠ¨åˆ·æ–°æŸ¥ç»“æœ...", "#ff9800");
                    location.reload();
                }
            }
            return;
        }

        // çŠ¶æ€C: å€’è®¡æ—¶ (Idle)
        if (data.status === 'idle') {
            if (now < data.nextRunTime) {
                const diff = data.nextRunTime - now;
                const m = Math.floor((diff % 3600000) / 60000);
                const s = Math.floor((diff % 60000) / 1000);
                updateStatus(`â³ [è°ƒè¯•] ä¸‹æ¬¡ç»­æœŸ: ${m}åˆ† ${s}ç§’`, "#2196f3");
            } else {
                startCycle();
            }
        }

    }, 1000);

    // --- 7. äº‹ä»¶äº¤äº’ ---
    renderLogs();
    
    document.getElementById('kb-reset').onclick = () => {
        if(confirm("ç¡®å®šè¦é‡ç½®è„šæœ¬çŠ¶æ€å—ï¼Ÿ")) {
            data = { nextRunTime: 0, status: 'idle', logs: [], lastExpiryMinutes: 0, warmupEndTime: 0, validateStartTime: 0 };
            localStorage.setItem(CONFIG.storageKey, JSON.stringify(data));
            location.reload();
        }
    };
    
    document.getElementById('kb-check').onclick = () => {
        const t = getExpiryDisplay();
        const m = getCleanExpiryMinutes();
        log(`ğŸ” æ‰‹åŠ¨æµ‹è¯•è¯»å–: ${t} (åˆ†é’Ÿæ•°: ${m})`, "#03a9f4");
        alert(`è¯»å–åˆ°çš„æ—¶é—´:\n${t}\nè§£æåˆ†é’Ÿ: ${m}`);
    };
    
    document.getElementById('kb-hide').onclick = () => {
        const content = document.getElementById('kb-content');
        const btn = document.getElementById('kb-hide');
        const isHidden = content.style.display === 'none';
        content.style.display = isHidden ? 'block' : 'none';
        btn.innerText = isHidden ? "[-]" : "[+]";
    };

    log("ğŸ¤– v4.0 è°ƒè¯•ç‰ˆå¯åŠ¨ (å®Œæ•´åŠŸèƒ½+è‡ªåŠ¨åˆ·æ–°å¤„ç†)", "#fff");

})();
